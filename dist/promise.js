/*Copyright (c) Kaerus 2012 (kaerus.com), Anders Elo <anders @ kaerus com>*/
var root;try{root=global}catch(e){try{root=window}catch(e){root=this}}(function(){"use strict";function o(e){if(e){for(var t in o.prototype)e[t]=o.prototype[t];return e}if(!(this instanceof o))return new o}var e=root.setImmediate;if(typeof e!="function")if(typeof root.process!="undefined"&&root.process&&typeof root.process.nextTick=="function")e=root.process.nextTick;else if(root.vertx&&typeof root.vertx.runOnLoop=="function")e=root.vertx.runOnLoop;else if(typeof root.MessageChannel!="undefined"){var t=[],n=new root.MessageChannel;n.port1.onmessage=function(){t.shift()()},e=function(e){t[t.length]=e,n.port2.postMessage()}}else{if(typeof root.setTimeout!="function")throw"No candidate for setImmediate";e=root.setTimeout}var r=0,i=1,s=2;o.prototype.resolve=function(){var e,t,n=this._state,s=this.resolved;while(e=this._calls.shift()){t=e[r];if(typeof e[this._state]=="function"){try{s=e[this._state].call(this,this.resolved)}catch(u){t.reject(u);continue}if(s instanceof o||s&&typeof s.then=="function"){s.then(function(e){t.fulfill(e)},function(e){t.reject(e)});continue}n=i}t._state=n,t.resolved=s,t._calls&&t.resolve()}},o.prototype.then=function(t,n){var r=this,i=new o;return this._calls||(this._calls=[]),this._calls[this._calls.length]=[i,t,n],this.resolved&&e(function(){r.resolve()}),i},o.prototype.spread=function(e,t){function r(t){return Array.isArray(t)||(t=[t]),e.apply(n,t)}var n=this;return this.then(r,t)},o.prototype.fulfill=function(e){if(this._state)return;return arguments.length>1&&(e=[].slice.call(arguments)),this._state=i,this.resolved=e,this._timer&&this.timeout(null),this._calls&&this.resolve(),this},o.prototype.reject=function(e){if(this._state)return;return this._state=s,this.resolved=e,this._timer&&this.timeout(null),this._calls&&this.resolve(),this},o.prototype.when=function(t){function s(t,n){var r;return n instanceof o||n&&typeof n.then=="function"?n.then(function(e){t.fulfill(e)},function(e){t.reject(e)}):e(function(){try{r=n.call(t),t.fulfill(r)}catch(e){t.reject(e)}}),t}function u(e,n){return s(e,t[n]).then(function(e){i[n]=e}),function(){return e}}var n,r=n=this,i=[];if(!Array.isArray(t))return s(this,t);for(var a=0;a<t.length;a++)n=r,r=n.then(u(n,a));return n.then(function(){return i})},o.prototype.attach=function(e){return this.attached=e,this},o.prototype.abort=function(e){return this.attached&&typeof this.attached.abort=="function"&&this.attached.abort(),this.reject(e),this},o.prototype.timeout=function(e,t){if(e===null)return clearTimeout(this._timer),this;if(this._state)return this;var n=this;return t||(t=function(){n.abort("timed out")}),this._timer=setTimeout(t,e),this};if(typeof exports=="object")typeof module!==undefined&&module.exports?exports=module.exports=o:exports.Promise=o;else if(typeof define=="function"&&define.amd)define("promise",[],function(){return o});else{if(typeof root!="object")throw"Unable to export Promise";root.Promise=o}})();